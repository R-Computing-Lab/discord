---
title: "Demonstrating Categorical Predictors in Discordant-Kinship Regressions"
author: Yoo Ri Hwang, Jonathan Trattner, and S. Mason Garrison

output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{categorical_predictors}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction



This vignette provides a comprehensive guide to incorporating categorical predictors in discordant-kinship regression analyses using the 'discord' package. The focus will be on the handling of different types of categorical variables—mixed variables and between-dyad variables—within the discordant-kinship framework.

## Data and Research Question

We will be using a subset of the 1979 National Longitudinal Survey of Youth (NLSY79) to explore whether sex and race are significant significant predictors for flu vaccination rates among . This data set contains demographic variables such as race and sex, and behavioral measurements like flu vaccination rates and SES at age 40.


# Data cleaning

First, we load the package and the data.
 
```{r setup, message = FALSE}

# For easy data manipulation
library(dplyr)
# For kinship linkages
library(NlsyLinks)
# For discordant-kinship regression
library(discord)
# pipe
library(magrittr)

#data
data(data_flu_ses)
```

The code chunk below is from Regression demonstration vignette in this package.
For explanation of basic logic for this, please refer to the [regression demonstration vignette](https://github.com/R-Computing-Lab/discord/blob/main/vignettes/regression.Rmd).

```{r set-df-link}

link_vars <- c("FLU_total", "FLU_2008", "FLU_2010", 
               "FLU_2012", "FLU_2014", "FLU_2016", 
               "S00_H40", "RACE", "SEX")

# Specify NLSY database and kin relatedness 

link_pairs <- Links79PairExpanded %>%
  filter(RelationshipPath == "Gen1Housemates" & RFull == 0.5)

df_link <- CreatePairLinksSingleEntered(outcomeDataset = data_flu_ses,
                                        linksPairDataset = link_pairs,
                                        outcomeNames = link_vars)

consistent_kin <- df_link %>% 
  group_by(SubjectTag_S1, SubjectTag_S2) %>% 
  count(FLU_2008_S1, FLU_2010_S1, 
        FLU_2012_S1, FLU_2014_S1, 
        FLU_2016_S1, FLU_2008_S2, 
        FLU_2010_S2, FLU_2012_S2, 
        FLU_2014_S2, FLU_2016_S2) %>% 
  na.omit()

df_link <- semi_join(df_link,
          consistent_kin, 
          by = c("SubjectTag_S1", "SubjectTag_S2"))

# We removed the pair when DV is missing. 

df_link <- df_link %>%
           filter(!is.na(FLU_total_S1) & !is.na(FLU_total_S2))

# We only pick one pair per one household so that we don't violate independence assumption.


df_link<-df_link%>%
  group_by(ExtendedID) %>%
  slice_sample() %>%
  ungroup()

```

The data is almost ready.   

# Categorical predictor

The 'discord_data()' function restructures the paired data. 
In the pair, the one with the higher DV is assigned to be "_1" and the other one is assigned to be "_2".

In this example, we are going to use sex and race as categorical variables for the demonstrating purpose. We referred to Kenney et al.,(2006) for idea about how to handle categorical predictors.

## When the categorical predictor is a mixed variable

The categorical predictor is a mixed variable when variances exists within- and between-dyads. 
For example, the sex is a mix variable in this example.

By using the 'discord_data()' function, we can prepare data for the analysis as following:

```{r}

cat_sex <- discord_data(
            data = df_link,
            outcome = "FLU_total",
            predictors = "S00_H40",
            sex="SEX",
            race="RACE",
            demographics = "sex",
            pair_identifiers = c("_S1","_S2"),
            added_coding="added_coding")
```

A random slice of this data looks as following:

```{r sex, echo = FALSE, eval = knitr::is_html_output(),error=FALSE}

cat_sex %>%
slice(1:500) %>%
    slice_sample(n = 6) %>%
    kableExtra::kbl('html', align = "c")%>%
    kableExtra::kable_styling(full_width = FALSE)
```

The sex compositions in the data are as following:

```{r preview-sex, echo = FALSE, eval = knitr::is_html_output()}

cat_sex %>%
  group_by(SEX_1, SEX_2)%>%
  summarize( n(),.groups = 'drop')%>%
  kableExtra::kbl('html', align = "c",col.names=c("SEX_1","SEX_2","sample_size"))%>%
  kableExtra::kable_styling(full_width = FALSE) 

```


Considering the DV (the difference score of outcome variable in the pair) is a between-dyad variable, we can make the sex variable as a between-dyad variable as well. 

The 'discord_data()' function automatically generated binary match and multi match for sex. 

The binary-match variable indicates whether the pair is the same-sex pair (coded as "1") or mixed-sex pair (coded as "0").

The multi-match variable indicates whether the sex of the two people in the same pair is "1" (coded as "1") or "0" (coded as "0") or the pair is mixed-sex pair (coded as "mixed"). 

By doing so, the sex variable (which was initially a mixed variable) becomes between-dyad variable. 

Researchers can choose between two options based on their research question.

The regression model with the binary match sex variable can be conducted as such:

```{r echo = FALSE, eval = knitr::is_html_output()}

 lm(FLU_total_diff ~ FLU_total_mean + S00_H40_diff +  S00_H40_mean + SEX_binarymatch.x,
    data = cat_sex) %>%
  broom::tidy() %>%
  mutate(p.value = scales::pvalue(p.value, add_p = TRUE),
         across(.cols = where(is.numeric), ~round(.x, 3))) %>%
  rename("Standard Error" = std.error,
         "T Statistic" = statistic) %>%
  rename_with(~snakecase::to_title_case(.x)) %>%
  kableExtra::kbl('html', align = "c") %>%
  kableExtra::kable_styling() %>%
  kableExtra::column_spec(1:5, extra_css = "text-align: center;")

```

The Sex variable were not significant control variable, meaning that the difference between same-sex pairs and mixed-sex pairs did not significantly predict the DV (FLU_total_diff). 


For more detailed results interpretation, please refer to the [regression demonstration vignette](https://github.com/R-Computing-Lab/discord/blob/main/vignettes/regression.Rmd)


The regression model with the multi match sex variable can be conducted as such:

```{r echo = FALSE, eval = knitr::is_html_output()}

 lm(FLU_total_diff ~ FLU_total_mean + S00_H40_diff +  S00_H40_mean + SEX_multimatch.x,
    data = cat_sex) %>%
  broom::tidy() %>%
  mutate(p.value = scales::pvalue(p.value, add_p = TRUE),
         across(.cols = where(is.numeric), ~round(.x, 3))) %>%
  rename("Standard Error" = std.error,
         "T Statistic" = statistic) %>%
  rename_with(~snakecase::to_title_case(.x)) %>%
  kableExtra::kbl('html', align = "c") %>%
  kableExtra::kable_styling() %>%
  kableExtra::column_spec(1:5, extra_css = "text-align: center;")

```

The Sex variables were not significant control variables.
The difference between the pairs that both have sex as "0" and the pairs that both have sex as "1" were not significantly predicts the DV (FLU_total_diff).
The difference between the pairs that both have sex as "0" and the mixed-sex pairs were not significantly predicts the DV as well. 

For more detailed results interpretation, please refer to the [regression demonstration vignette](https://github.com/R-Computing-Lab/discord/blob/main/vignettes/regression.Rmd)


## When the categorical predictor is a between-dyad variable

The categorical predictor is a between-dyad variable when the two people in the same dyad share the same score (or same response).


For demonstration purpose, we force the race variable to be between-dyad variable, meaning that we only include the same-race pairs in the data. 

By using 'discord_data()' function, we can prepare data for the analysis as following:

```{r}

cat_race <- discord_data(
            data = df_link,
            outcome = "FLU_total",
            predictors = "S00_H40",
            sex="SEX",
            race="RACE",
            demographics = "race",
            pair_identifiers = c("_S1","_S2"),
            added_coding="added_coding") %>%
# forcing race to be a between-dyad variable for the demonstration purpose
            filter(RACE_1==RACE_2)

```

The race compositions in the data set are:

```{r preview-race, echo = FALSE, eval = knitr::is_html_output()}
cat_race %>%
  group_by(RACE_1, RACE_2)%>%
  summarize( n(),.groups = 'drop')%>%
  kableExtra::kbl('html', align = "c",col.names=c("RACE_1","RACE_2","sample_size"))%>%
  kableExtra::kable_styling(full_width = FALSE) 
  
```


A random slice of this data looks as following:

```{r race, echo = FALSE, eval = knitr::is_html_output(),error=FALSE}

cat_race %>%
slice(1:500) %>%
    slice_sample(n = 6) %>%
    kableExtra::kbl('html', align = "c") %>%
    kableExtra::kable_styling(full_width = FALSE)
```



The binary-match variable indicates whether the pair is the same-race pair (coded as "1") or mixed-race pair (coded as "0"). Because the race variable is a between-dyad variable, all the pairs have a value of "1" in this example. 

The multi-match variable indicates whether the race of the two people in the same pair is "1" (coded as "1") or "0" (coded as "0") or mixed (coded as "mixed"). No pair have "mixed" value because race is a between-dyad variable in this example. 

The regression model with multi-match race variable as a one of the predictor can be conducted  as such:

```{r echo = FALSE, eval = knitr::is_html_output()}

 lm(FLU_total_diff ~ FLU_total_mean + S00_H40_diff +  S00_H40_mean + RACE_multimatch.x,
    data = cat_race) %>%
  broom::tidy() %>%
  mutate(p.value = scales::pvalue(p.value, add_p = TRUE),
         across(.cols = where(is.numeric), ~round(.x, 3))) %>%
  rename("Standard Error" = std.error,
         "T Statistic" = statistic) %>%
  rename_with(~snakecase::to_title_case(.x)) %>%
  kableExtra::kbl('html', align = "c") %>%
  kableExtra::kable_styling() %>%
  kableExtra::column_spec(1:5, extra_css = "text-align: center;")

```

The difference between the pairs with the race as "0" and "1" were not a significant predictor, meaning that it did not significantly predict DV. 

For the results interpretation, please refer to the [regression demonstration vignette](https://github.com/R-Computing-Lab/discord/blob/main/vignettes/regression.Rmd)


## When we have two categorical predictors

We can include both sex and race as predictors as well. 

First, we restructure the data for the kinship-discordant regression using the 'discord_data()'function.

```{r}

cat_both <- discord_data(
            data = df_link,
            outcome = "FLU_total",
            predictors = "S00_H40",
            sex="SEX",
            race="RACE",
            demographics = "both",
            pair_identifiers = c("_S1","_S2"),
            added_coding="added_coding") %>%
# forcing race to be between-dyad variable for demonstration purpose
            filter(RACE_1==RACE_2)

```


A random slice of this data looks as following:

```{r echo = FALSE, eval = knitr::is_html_output(),error=FALSE}

cat_both %>%
slice(1:500) %>%
    slice_sample(n = 6) %>%
    kableExtra::kbl('html', align = "c")%>%
    kableExtra::kable_styling(full_width = FALSE) 
```

 We can perform a regression using the binary-match sex variable and multi-match race variable as such:
 
```{r echo = FALSE, eval = knitr::is_html_output()}
 
 lm(FLU_total_diff ~ FLU_total_mean + S00_H40_diff +  S00_H40_mean + RACE_multimatch.x + SEX_binarymatch.x,
    data = cat_both) %>%
  broom::tidy() %>%
  mutate(p.value = scales::pvalue(p.value, add_p = TRUE),
         across(.cols = where(is.numeric), ~round(.x, 3))) %>%
  rename("Standard Error" = std.error,
         "T Statistic" = statistic) %>%
  rename_with(~snakecase::to_title_case(.x)) %>%
  kableExtra::kbl('html', align = "c") %>%
  kableExtra::kable_styling() %>%
  kableExtra::column_spec(1:5, extra_css = "text-align: center;")

```

we can perform a regression analysis using multi-match sex and race variables as well:

```{r echo = FALSE, eval = knitr::is_html_output()}


 lm(FLU_total_diff ~ FLU_total_mean + S00_H40_diff +  S00_H40_mean + RACE_multimatch.x + SEX_multimatch.x,
    data = cat_both) %>%
  broom::tidy() %>%
  mutate(p.value = scales::pvalue(p.value, add_p = TRUE),
         across(.cols = where(is.numeric), ~round(.x, 3))) %>%
  rename("Standard Error" = std.error,
         "T Statistic" = statistic) %>%
  rename_with(~snakecase::to_title_case(.x)) %>%
  kableExtra::kbl('html', align = "c") %>%
  kableExtra::kable_styling() %>%
  kableExtra::column_spec(1:5, extra_css = "text-align: center;")

```
 
 
For the results interpretation, please refer to the [regression demonstration vignette](https://github.com/R-Computing-Lab/discord/blob/main/vignettes/regression.Rmd)

# Conclusion

In this vignette, we demonstrated how to include categorical predictors in discordant-kinship regressions using the 'discord' package. 

# References

Kenny, D. A., Kashy, D. A., & Cook, W. L. (2006). Dyadic data analysis. New York, NY:
Guilford
